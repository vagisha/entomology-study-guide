<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse Insects - Entomology Study Guide</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="shared.css">
  <style>
    /* Browse-specific styles */
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .nav-links {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .nav-links a {
      background: #34495e;
      color: #74c69d;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 8px;
    }
    .nav-links a:hover { background: #5d6d7e; }
    
    .container { max-width: 1200px; margin: 0 auto; }
    
    .order-list {
      margin-bottom: 30px;
    }
    
    .metamorphosis-section {
      margin-bottom: 40px;
    }
    
    .metamorphosis-section h2 {
      color: #74c69d;
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    
    .metamorphosis-section .description {
      color: #aaa;
      margin-bottom: 15px;
      font-size: 0.9em;
    }
    
    .order-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .order-card {
      background: linear-gradient(135deg, #34495e 0%, #5d6d7e 100%);
      padding: 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .order-card.optional {
      border: 4px dashed #ffa500;
    }
    
    .order-card:hover { transform: translateY(-5px); }
    .order-card h3 { margin-bottom: 5px; }
    .order-card .count { opacity: 0.8; font-size: 0.9em; }
    
    .family-grid {
      display: none;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .family-grid.active { display: grid; }
    
    .family-card {
      background: linear-gradient(135deg, #4a5f5a 0%, #5d7570 100%);
      border-radius: 12px;
      padding: 15px;
      border: 2px solid #40916c;
    }
    
    .family-card.optional {
      border: 4px dashed #ffa500;
      background: linear-gradient(135deg, #3d4f4a 0%, #4a5f5a 100%);
    }
    
    .family-card.optional h4::after {
      content: " ‚≠ê";
      color: #ffa500;
      font-size: 0.8em;
    }
    
    .family-card h4 {
      color: #f0f0f0;
      margin-bottom: 5px;
    }
    
    .family-card .common-name {
      color: #e0e0e0;
      font-size: 1em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .family-card .marks {
      color: #c0c0c0;
      font-size: 0.85em;
      line-height: 1.4;
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      font-style: italic;
    }
    
    .image-container {
      width: 100%;
      height: 200px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .image-container .placeholder {
      color: #666;
      text-align: center;
      padding: 20px;
    }
    
    .image-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    .image-container:hover .image-nav {
      display: flex;
    }
    
    .image-nav:hover {
      background: rgba(0,0,0,0.8);
    }
    
    .image-nav.prev {
      left: 10px;
    }
    
    .image-nav.next {
      right: 10px;
    }
    
    .image-counter {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }
    
    .image-container:hover .image-counter {
      display: block;
    }
    }
    
    .links {
      margin-top: 10px;
    }
    
    .links a {
      flex: 1;
      text-align: center;
    }
    
    .back-btn {
      background: #34495e;
      color: #74c69d;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
      display: none;
    }
    
    .back-btn.active { display: inline-block; }
    .back-btn:hover { background: #5d6d7e; }
    
    .order-title {
      display: none;
      color: #74c69d;
      margin-bottom: 20px;
      font-size: 2em;
    }
    
    .order-title.active { display: flex; align-items: center; gap: 15px; }
    
    .order-info-box {
      background: #3d4952;
      border: 2px solid #74c69d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }
    
    .order-info-box.active { display: block; }
    
    .order-info-box h3 {
      color: #74c69d;
      margin-bottom: 10px;
      font-size: 1.2em;
    }
    
    .order-info-box .info-row {
      margin-bottom: 8px;
      line-height: 1.6;
    }
    
    .order-info-box .info-label {
      color: #74c69d;
      font-weight: bold;
      display: inline-block;
      min-width: 120px;
    }
    
    .order-info-box .info-value {
      color: #eee;
    }
    
    .notes-section {
      background: #3d4952;
      border: 2px solid #74c69d;
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .notes-section h4 {
      color: #74c69d;
      margin-bottom: 10px;
      font-size: 1em;
    }
    
    .notes-section textarea {
      width: 100%;
      min-height: 80px;
      background: #2c3e50;
      color: #eee;
      border: 1px solid #5d6d7e;
      border-radius: 6px;
      padding: 10px;
      font-family: inherit;
      font-size: 0.9em;
      resize: vertical;
    }
    
    .notes-section textarea:focus {
      outline: none;
      border-color: #74c69d;
    }
    
    .notes-section button {
      padding: 8px 16px;
      margin-top: 8px;
      font-size: 0.9em;
    }
    
    .notes-display {
      background: #2c3e50;
      padding: 10px;
      border-radius: 6px;
      margin-top: 8px;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    
    .notes-display.empty {
      color: #666;
      font-style: italic;
    }
    
    .add-note-btn {
      background: #74c69d;
      color: #2c3e50;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      margin-top: 10px;
    }
    
    .add-note-btn:hover {
      background: #52b788;
    }
    
    /* Modal styles for notes */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: #2c3e50;
      border: 2px solid #74c69d;
      border-radius: 12px;
      padding: 25px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-content h3 {
      color: #74c69d;
      margin-bottom: 15px;
    }
    
    .modal-content textarea {
      width: 100%;
      min-height: 200px;
      background: #34495e;
      color: #eee;
      border: 1px solid #5d6d7e;
      border-radius: 6px;
      padding: 10px;
      font-family: system-ui, sans-serif;
      font-size: 14px;
      resize: vertical;
    }
    
    .modal-content textarea:focus {
      outline: none;
      border-color: #74c69d;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: flex-end;
    }
    
    .modal-buttons button {
      padding: 10px 20px;
    }
    
    .modal-buttons .cancel-btn {
      background: #5d6d7e;
    }
    
    .modal-buttons .cancel-btn:hover {
      background: #6d7d8e;
    }
    
    /* Image modal styles */
    .image-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      cursor: pointer;
    }
    
    .image-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .image-modal-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }
    
    .image-modal-content img {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .image-modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.9);
      color: #2c3e50;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    .image-modal-nav:hover {
      background: white;
    }
    
    .image-modal-nav.prev {
      left: 20px;
    }
    
    .image-modal-nav.next {
      right: 20px;
    }
    
    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
    }
    
    .image-modal-close:hover {
      color: #74c69d;
    }
    
    .image-modal-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
    }
    
    .image-modal-title {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: bold;
    }
    
    .order-links {
      display: flex;
      gap: 10px;
    }
    
    .order-links a,
    .order-links button {
      background: #74c69d;
      color: #2c3e50;
      padding: 8px 16px;
      text-decoration: none;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      margin: 0;
    }
    
    .order-links a:hover,
    .order-links button:hover { background: #52b788; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üêõ Entomology Study Guide</h1>
    <div class="nav-links">
      <a href="index.html">Flashcards</a>
      <a href="browse.html">Browse Insects</a>
      <a href="#" onclick="exportNotes(); return false;">üíæ Export Notes</a>
      <a href="#" onclick="document.getElementById('import-file').click(); return false;">üì• Import Notes</a>
      <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importNotes(event)">
    </div>
  </div>

  <div class="container">
    <button class="back-btn" id="back-btn" onclick="showOrders()">‚Üê Back to Orders</button>
    <h2 class="order-title" id="order-title"></h2>
    <div class="order-info-box" id="order-info-box"></div>
    
    <div class="order-list" id="order-list"></div>
    <div class="family-grid" id="family-grid"></div>
  </div>
  
  <!-- Modal for editing notes -->
  <div class="modal" id="note-modal">
    <div class="modal-content">
      <h3 id="modal-title">Edit Note</h3>
      <textarea id="modal-textarea" placeholder="Enter your notes here..."></textarea>
      <div class="modal-buttons">
        <button class="cancel-btn" onclick="closeNoteModal()">Cancel</button>
        <button onclick="saveNoteFromModal()">Save Note</button>
      </div>
    </div>
  </div>

  <!-- Modal for viewing images -->
  <div class="image-modal" id="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <div class="image-modal-title" id="image-modal-title"></div>
    <div class="image-modal-content" onclick="event.stopPropagation()">
      <img id="image-modal-img" src="" alt="">
      <button class="image-modal-nav prev" onclick="event.stopPropagation(); prevModalImage()">‚Äπ</button>
      <button class="image-modal-nav next" onclick="event.stopPropagation(); nextModalImage()">‚Ä∫</button>
      <div class="image-modal-counter" id="image-modal-counter"></div>
    </div>
  </div>

  <script src="shared.js"></script>
  <script>
    // Notes management using localStorage
    const NotesManager = {
      getOrderNote: function(order) {
        return localStorage.getItem(`note-order-${order}`) || '';
      },
      setOrderNote: function(order, note) {
        localStorage.setItem(`note-order-${order}`, note);
      },
      getFamilyNote: function(family) {
        return localStorage.getItem(`note-family-${family}`) || '';
      },
      setFamilyNote: function(family, note) {
        localStorage.setItem(`note-family-${family}`, note);
      }
    };
    
    // Order descriptions and characteristics
    const orderInfo = {
      "Acari": {
        meaning: "Mite",
        characteristics: "Non-insect arthropod, 8 legs",
        wings: "None",
        children: "Nymphs ‚Äì like adults but smaller",
        commonName: "Ticks & Mites (Non-insect Arthropod)"
      },
      "Blattodea": {
        meaning: "Avoiding light",
        characteristics: "Head under thorax",
        wings: "2 pairs, leathery",
        children: "Nymphs ‚Äì like adults but no wings",
        commonName: "Cockroaches & Termites"
      },
      "Coleoptera": {
        meaning: "Hard wings",
        characteristics: "Hard shell",
        wings: "2 pairs, front wings hardened",
        children: "Larvae ‚Äì variable: grub-like or worm-like",
        commonName: "Beetles"
      },
      "Dermaptera": {
        meaning: "Leathery wings",
        characteristics: "Pincer tails",
        wings: "2 pairs, short, tough",
        children: "Nymphs ‚Äì like adults but no wings",
        commonName: "Earwigs"
      },
      "Diptera": {
        meaning: "Two wings",
        characteristics: "Only one pair of wings",
        wings: "1 pair only",
        children: "Larvae ‚Äì maggots",
        commonName: "True Flies"
      },
      "Hemiptera": {
        meaning: "Half wings",
        characteristics: "Sucking mouthparts",
        wings: "Variable - 2 pairs, X shaped or colored line OR wings colored or clear held straight over back OR wingless (ex. Scale insect)",
        children: "Nymphs ‚Äì like adults but wingless",
        commonName: "True Bugs (cicadas, aphids, planthoppers, leafhoppers, assassin bugs, bed bugs, shield bugs)"
      },
      "Hymenoptera": {
        meaning: "Membrane wings",
        characteristics: "Wasp waist & stingers",
        wings: "2 pairs, except most ants (no wings)",
        children: "Larvae ‚Äì maggot or grub-like",
        commonName: "Bees, Wasps, Ants & Sawflies"
      },
      "Lepidoptera": {
        meaning: "Scaly wings",
        characteristics: "Colored scales on wings",
        wings: "2 pairs with colored scales",
        children: "Larvae ‚Äì caterpillars",
        commonName: "Butterflies & Moths"
      },
      "Orthoptera": {
        meaning: "Straight wings",
        characteristics: "Jumping hind legs",
        wings: "2 pairs, folded over back",
        children: "Nymphs ‚Äì like adults but no wings",
        commonName: "Grasshoppers, Crickets & Katydids"
      },
      "Mantodea": {
        meaning: "Like a prophet",
        characteristics: "Grabbing front legs",
        wings: "2 pairs, doubled over on back",
        children: "Nymphs ‚Äì like adults but no wings",
        commonName: "Mantises"
      },
      "Neuroptera": {
        meaning: "Nerve wings",
        characteristics: "Net like wings",
        wings: "2 pairs w/ lots of veins, tent-like",
        children: "Larvae ‚Äì long & flat, w/ BIG mandibles",
        commonName: "Lacewings & Antlions"
      },
      "Odonata": {
        meaning: "Toothed flies",
        characteristics: "Enormous eyes",
        wings: "2 pairs: do not fold over back",
        children: "Nymphs ‚Äì aquatic",
        commonName: "Dragonflies & Damselflies"
      },
      "Phasmatodea": {
        meaning: "Like a ghost",
        characteristics: "Stick-like body",
        wings: "2 pairs (males), females wingless",
        children: "Nymphs ‚Äì like adults but wingless",
        commonName: "Walkingsticks"
      }
    };
    
    // Metamorphosis type for each order
    const metamorphosisTypes = {
      ametabolous: {
        title: "Ametabolous (No Metamorphosis)",
        description: "Develop directly from egg to adult with no significant body changes",
        orders: ["Acari", "Protura", "Diplura", "Archaeognatha", "Zygentoma"]
      },
      hemimetabolous: {
        title: "Hemimetabolous (Incomplete Metamorphosis)",
        description: "Develop through nymph stages that resemble adults (egg ‚Üí nymph ‚Üí adult)",
        orders: ["Ephemeroptera", "Odonata", "Blattodea", "Mantodea", "Embioptera", 
                 "Dermaptera", "Plecoptera", "Orthoptera", "Phasmatodea", "Psocodea", 
                 "Hemiptera", "Thysanoptera"]
      },
      holometabolous: {
        title: "Holometabolous (Complete Metamorphosis)",
        description: "Develop through distinct larval and pupal stages (egg ‚Üí larva ‚Üí pupa ‚Üí adult)",
        orders: ["Megaloptera", "Neuroptera", "Coleoptera", "Mecoptera", "Raphidioptera", 
                 "Siphonaptera", "Diptera", "Trichoptera", "Lepidoptera", "Hymenoptera"]
      }
    };
    
    // BugGuide links - edit this object to add more links
    const bugguideLinks = {
      orders: {
        "Coleoptera": "https://bugguide.net/node/view/60",
        "Lepidoptera": "https://bugguide.net/node/view/81",
        "Hymenoptera": "https://bugguide.net/node/view/91",
        "Diptera": "https://bugguide.net/node/view/55",
        "Hemiptera": "https://bugguide.net/node/view/78",
        "Orthoptera": "https://bugguide.net/node/view/70",
        "Odonata": "https://bugguide.net/node/view/191",
        "Blattodea": "https://www.bugguide.net/node/view/342386"
      },
      families: {
        "Coccinellidae": "https://bugguide.net/node/view/179",
        "Carabidae": "https://bugguide.net/node/view/186",
        "Scarabaeidae": "https://bugguide.net/node/view/187",
        "Buprestidae": "https://bugguide.net/node/view/162"
      }
    };
    
    let insectData = [];

    // Load insects data and initialize
    async function initBrowse() {
      try {
        insectData = await loadInsectsData();
        groupInsectsByOrder();
        showOrders();
      } catch (error) {
        console.error('Error initializing browse:', error);
      }
    }

    // OLD DATA BELOW - TO BE REMOVED
    /*
      // Acari (Non-insect Arthropod)
      { name: "Hardback Tick", order: "Acari", family: "Ixodidae", wiki: "Ixodidae", bugguide: "1" },
      
      // Protura
      { name: "Proturan", order: "Protura", family: "Protura", wiki: "Protura", bugguide: "1", optional: true },
      
      // Diplura
      { name: "Dipluran", order: "Diplura", family: "Diplura", wiki: "Diplura", bugguide: "1" },
      
      // Archaeognatha
      { name: "Bristletail", order: "Archaeognatha", family: "Archaeognatha", wiki: "Archaeognatha", bugguide: "1" },
      
      // Zygentoma
      { name: "Silverfish/Firebrat", order: "Zygentoma", family: "Zygentoma", wiki: "Zygentoma", bugguide: "1" },
      
      // Ephemeroptera
      { name: "Mayfly", order: "Ephemeroptera", family: "Ephemeridae", wiki: "Ephemeridae", bugguide: "1" },
      
      // Odonata
      { name: "Darner", order: "Odonata", family: "Aeshnidae", wiki: "Aeshnidae", bugguide: "1" },
      { name: "Clubtail", order: "Odonata", family: "Gomphidae", wiki: "Gomphidae", bugguide: "1", optional: true },
      { name: "Skimmer", order: "Odonata", family: "Libellulidae", wiki: "Libellulidae", bugguide: "1" },
      { name: "Spread-wing Damselfly", order: "Odonata", family: "Lestidae", wiki: "Lestidae", bugguide: "1" },
      { name: "Narrow-winged Damselfly", order: "Odonata", family: "Coenagrionidae", wiki: "Coenagrionidae", bugguide: "1" },
      
      // Blattodea
      { name: "Termite", order: "Blattodea", family: "Termitidae", wiki: "Termitidae", bugguide: "1" },
      { name: "Household Roach", order: "Blattodea", family: "Blattidae", wiki: "Blattidae", bugguide: "1" },
      { name: "Brown-hooded Roach", order: "Blattodea", family: "Cryptocercidae", wiki: "Cryptocercidae", bugguide: "1", optional: true },
      
      // Mantodea
      { name: "Mantis", order: "Mantodea", family: "Mantidae", wiki: "Mantidae", bugguide: "1" },
      
      // Embioptera
      { name: "Webspinner", order: "Embioptera", family: "Embioptera", wiki: "Embioptera", bugguide: "1" },
      
      // Dermaptera
      { name: "Earwig", order: "Dermaptera", family: "Dermaptera", wiki: "Dermaptera", bugguide: "1" },
      
      // Plecoptera
      { name: "Stonefly", order: "Plecoptera", family: "Perlidae", wiki: "Perlidae", bugguide: "1" },
      
      // Orthoptera
      { name: "Pygmy Grasshopper", order: "Orthoptera", family: "Tetrigidae", wiki: "Tetrigidae", bugguide: "1", optional: true },
      { name: "Short-horned Grasshopper", order: "Orthoptera", family: "Acrididae", wiki: "Acrididae", bugguide: "1" },
      { name: "Katydid", order: "Orthoptera", family: "Tettigoniidae", wiki: "Tettigoniidae", bugguide: "1" },
      { name: "Camel Cricket", order: "Orthoptera", family: "Rhaphidophoridae", wiki: "Rhaphidophoridae", bugguide: "1" },
      { name: "Cricket", order: "Orthoptera", family: "Gryllidae", wiki: "Gryllidae", bugguide: "1" },
      { name: "Mole Cricket", order: "Orthoptera", family: "Gryllotalpidae", wiki: "Gryllotalpidae", bugguide: "1" },
      
      // Phasmatodea
      { name: "Common Walkingstick", order: "Phasmatodea", family: "Diapheromeridae", wiki: "Diapheromeridae", bugguide: "1" },
      
      // Psocodea
      { name: "Book/Bark Lice", order: "Psocodea", family: "Psocodea", wiki: "Psocodea", bugguide: "1" },
      
      // Hemiptera
      { name: "Toad Bug", order: "Hemiptera", family: "Gelastocoridae", wiki: "Gelastocoridae", bugguide: "1", optional: true },
      { name: "Water Strider", order: "Hemiptera", family: "Gerridae", wiki: "Gerridae", bugguide: "1" },
      { name: "Bed Bug", order: "Hemiptera", family: "Cimicidae", wiki: "Cimicidae", bugguide: "1" },
      { name: "Plant Bug", order: "Hemiptera", family: "Miridae", wiki: "Miridae", bugguide: "1", optional: true },
      { name: "Assassin Bug", order: "Hemiptera", family: "Reduviidae", wiki: "Reduviidae", bugguide: "1" },
      { name: "Metallic Shield Bug", order: "Hemiptera", family: "Scutelleridae", wiki: "Scutelleridae", bugguide: "1" },
      { name: "Lace Bug", order: "Hemiptera", family: "Tingidae", wiki: "Tingidae", bugguide: "1", optional: true },
      { name: "Seed Bug", order: "Hemiptera", family: "Lygaeidae", wiki: "Lygaeidae", bugguide: "1", optional: true },
      { name: "Leaf-footed Bug", order: "Hemiptera", family: "Coreidae", wiki: "Coreidae", bugguide: "1" },
      { name: "Stink Bug", order: "Hemiptera", family: "Pentatomidae", wiki: "Pentatomidae", bugguide: "1" },
      { name: "Cicada", order: "Hemiptera", family: "Cicadidae", wiki: "Cicadidae", bugguide: "1" },
      { name: "Treehopper", order: "Hemiptera", family: "Membracidae", wiki: "Membracidae", bugguide: "1" },
      { name: "Froghopper", order: "Hemiptera", family: "Cercopidae", wiki: "Cercopidae", bugguide: "1" },
      { name: "Leafhopper", order: "Hemiptera", family: "Cicadellidae", wiki: "Cicadellidae", bugguide: "1" },
      { name: "Planthopper", order: "Hemiptera", family: "Fulgoridae", wiki: "Fulgoridae", bugguide: "1" },
      { name: "Aphid", order: "Hemiptera", family: "Aphididae", wiki: "Aphididae", bugguide: "1" },
      { name: "Mealybug", order: "Hemiptera", family: "Pseudococcidae", wiki: "Pseudococcidae", bugguide: "1" },
      { name: "Soft Scale", order: "Hemiptera", family: "Coccidae", wiki: "Coccidae", bugguide: "1" },
      { name: "Water Boatman", order: "Hemiptera", family: "Corixidae", wiki: "Corixidae", bugguide: "1" },
      { name: "Backswimmer", order: "Hemiptera", family: "Notonectidae", wiki: "Notonectidae", bugguide: "1" },
      { name: "Giant Water Bug", order: "Hemiptera", family: "Belostomatidae", wiki: "Belostomatidae", bugguide: "1" },
      { name: "Waterscorpion", order: "Hemiptera", family: "Nepidae", wiki: "Nepidae", bugguide: "1", optional: true },
      
      // Thysanoptera
      { name: "Thrips", order: "Thysanoptera", family: "Thripidae", wiki: "Thripidae", bugguide: "1" },
      
      // Megaloptera
      { name: "Dobsonfly", order: "Megaloptera", family: "Corydalidae", wiki: "Corydalidae", bugguide: "1" },
      
      // Neuroptera
      { name: "Green Lacewing", order: "Neuroptera", family: "Chrysopidae", wiki: "Chrysopidae", bugguide: "1" },
      { name: "Antlion", order: "Neuroptera", family: "Myrmeleontidae", wiki: "Myrmeleontidae", bugguide: "1" },
      
      // Coleoptera
      { name: "Ground and Tiger Beetle", order: "Coleoptera", family: "Carabidae", wiki: "Carabidae", bugguide: "180" },
      { name: "Predaceous Diving Beetle", order: "Coleoptera", family: "Dytiscidae", wiki: "Dytiscidae", bugguide: "1" },
      { name: "Whirligig Beetle", order: "Coleoptera", family: "Gyrinidae", wiki: "Gyrinidae", bugguide: "1" },
      { name: "Water Scavenger Beetle", order: "Coleoptera", family: "Hydrophilidae", wiki: "Hydrophilidae", bugguide: "1" },
      { name: "Water Penny Beetle", order: "Coleoptera", family: "Psephenidae", wiki: "Psephenidae", bugguide: "1" },
      { name: "Riffle Beetle", order: "Coleoptera", family: "Elmidae", wiki: "Elmidae", bugguide: "1" },
      { name: "Hister Beetle", order: "Coleoptera", family: "Histeridae", wiki: "Histeridae", bugguide: "1", optional: true },
      { name: "Rove Beetle", order: "Coleoptera", family: "Staphylinidae", wiki: "Staphylinidae", bugguide: "1" },
      { name: "Carrion Beetle", order: "Coleoptera", family: "Silphidae", wiki: "Silphidae", bugguide: "1", optional: true },
      { name: "Stag Beetle", order: "Coleoptera", family: "Lucanidae", wiki: "Lucanidae", bugguide: "1" },
      { name: "Bess Beetle", order: "Coleoptera", family: "Passalidae", wiki: "Passalidae", bugguide: "1" },
      { name: "Dung Beetle", order: "Coleoptera", family: "Scarabaeidae", wiki: "Scarabaeidae", bugguide: "187" },
      { name: "Metallic Wood-boring/Jewel Beetle", order: "Coleoptera", family: "Buprestidae", wiki: "Buprestidae", bugguide: "162" },
      { name: "Click Beetle", order: "Coleoptera", family: "Elateridae", wiki: "Elateridae", bugguide: "1", optional: true },
      { name: "Firefly", order: "Coleoptera", family: "Lampyridae", wiki: "Lampyridae", bugguide: "1", optional: true },
      { name: "Soldier Beetle", order: "Coleoptera", family: "Cantharidae", wiki: "Cantharidae", bugguide: "1" },
      { name: "Net-winged Beetle", order: "Coleoptera", family: "Lycidae", wiki: "Lycidae", bugguide: "1", optional: true },
      { name: "Checkered Beetle", order: "Coleoptera", family: "Cleridae", wiki: "Cleridae", bugguide: "1", optional: true },
      { name: "Lady-bird Beetle (Ladybug)", order: "Coleoptera", family: "Coccinellidae", wiki: "Coccinellidae", bugguide: "179" },
      { name: "Darkling Beetle", order: "Coleoptera", family: "Tenebrionidae", wiki: "Tenebrionidae", bugguide: "1" },
      { name: "Blister Beetle", order: "Coleoptera", family: "Meloidae", wiki: "Meloidae", bugguide: "1" },
      { name: "Long-horned Beetle", order: "Coleoptera", family: "Cerambycidae", wiki: "Cerambycidae", bugguide: "1" },
      { name: "Leaf Beetle", order: "Coleoptera", family: "Chrysomelidae", wiki: "Chrysomelidae", bugguide: "1" },
      { name: "Weevil", order: "Coleoptera", family: "Curculionidae", wiki: "Curculionidae", bugguide: "1" },
      { name: "Flat Bark Beetle", order: "Coleoptera", family: "Cucujidae", wiki: "Cucujidae", bugguide: "1" },
      
      // Mecoptera
      { name: "Snow Scorpionfly", order: "Mecoptera", family: "Boreidae", wiki: "Boreidae", bugguide: "1", optional: true },
      { name: "Common Scorpionfly", order: "Mecoptera", family: "Panorpidae", wiki: "Panorpidae", bugguide: "1", optional: true },
      
      // Raphidioptera
      { name: "Raphidiid Snakefly", order: "Raphidioptera", family: "Raphidiidae", wiki: "Raphidiidae", bugguide: "1" },
      
      // Siphonaptera
      { name: "Flea", order: "Siphonaptera", family: "Siphonaptera", wiki: "Siphonaptera", bugguide: "1" },
      
      // Diptera
      { name: "Crane Fly", order: "Diptera", family: "Tipulidae", wiki: "Tipulidae", bugguide: "1" },
      { name: "Mosquito", order: "Diptera", family: "Culicidae", wiki: "Culicidae", bugguide: "1" },
      { name: "Midge", order: "Diptera", family: "Chironomidae", wiki: "Chironomidae", bugguide: "1" },
      { name: "Black Fly", order: "Diptera", family: "Simuliidae", wiki: "Simuliidae", bugguide: "1", optional: true },
      { name: "Soldier Fly", order: "Diptera", family: "Stratiomyidae", wiki: "Stratiomyidae", bugguide: "1" },
      { name: "Horse Fly", order: "Diptera", family: "Tabanidae", wiki: "Tabanidae", bugguide: "1" },
      { name: "Robber Fly", order: "Diptera", family: "Asilidae", wiki: "Asilidae", bugguide: "1" },
      { name: "Bee Fly", order: "Diptera", family: "Bombyliidae", wiki: "Bombyliidae", bugguide: "1" },
      { name: "Hover/Flower Fly", order: "Diptera", family: "Syrphidae", wiki: "Syrphidae", bugguide: "1" },
      { name: "Fruit Fly, Husk Fly", order: "Diptera", family: "Tephritidae", wiki: "Tephritidae", bugguide: "1", optional: true },
      { name: "Pomace Fly, Fruit/Vinegar Fly", order: "Diptera", family: "Drosophilidae", wiki: "Drosophilidae", bugguide: "1" },
      { name: "House Fly", order: "Diptera", family: "Muscidae", wiki: "Muscidae", bugguide: "1" },
      { name: "Blow Fly", order: "Diptera", family: "Calliphoridae", wiki: "Calliphoridae", bugguide: "1" },
      { name: "Tachinid Fly", order: "Diptera", family: "Tachinidae", wiki: "Tachinidae", bugguide: "1", optional: true },
      { name: "Botfly", order: "Diptera", family: "Oestridae", wiki: "Oestridae", bugguide: "1", optional: true },
      
      // Trichoptera
      { name: "Caddisfly", order: "Trichoptera", family: "Limnephilidae", wiki: "Limnephilidae", bugguide: "1" },
      
      // Lepidoptera
      { name: "Brush-footed Butterfly", order: "Lepidoptera", family: "Nymphalidae", wiki: "Nymphalidae", bugguide: "1" },
      { name: "Geometer Moth", order: "Lepidoptera", family: "Geometridae", wiki: "Geometridae", bugguide: "1" },
      { name: "Tent Caterpillar/Lappet Moth", order: "Lepidoptera", family: "Lasiocampidae", wiki: "Lasiocampidae", bugguide: "1", optional: true },
      { name: "Snout Moth", order: "Lepidoptera", family: "Pyralidae", wiki: "Pyralidae", bugguide: "1", optional: true },
      { name: "Giant Silkworm Moth", order: "Lepidoptera", family: "Saturniidae", wiki: "Saturniidae", bugguide: "1" },
      { name: "Sphinx Moth", order: "Lepidoptera", family: "Sphingidae", wiki: "Sphingidae", bugguide: "1" },
      { name: "Tiger Moth", order: "Lepidoptera", family: "Erebidae", wiki: "Erebidae", bugguide: "1" },
      { name: "Owlet Moth", order: "Lepidoptera", family: "Noctuidae", wiki: "Noctuidae", bugguide: "1" },
      { name: "Clearwing Moth", order: "Lepidoptera", family: "Sesiidae", wiki: "Sesiidae", bugguide: "1" },
      { name: "Tortrix Moth", order: "Lepidoptera", family: "Tortricidae", wiki: "Tortricidae", bugguide: "1", optional: true },
      { name: "Skipper", order: "Lepidoptera", family: "Hesperiidae", wiki: "Hesperiidae", bugguide: "1" },
      { name: "Swallowtail", order: "Lepidoptera", family: "Papilionidae", wiki: "Papilionidae", bugguide: "1" },
      { name: "White or Sulfur", order: "Lepidoptera", family: "Pieridae", wiki: "Pieridae", bugguide: "1" },
      { name: "Hairstreak or Blue", order: "Lepidoptera", family: "Lycaenidae", wiki: "Lycaenidae", bugguide: "1" },
      
      // Hymenoptera
      { name: "Common Sawfly", order: "Hymenoptera", family: "Tenthredinidae", wiki: "Tenthredinidae", bugguide: "1" },
      { name: "Horntail", order: "Hymenoptera", family: "Siricidae", wiki: "Siricidae", bugguide: "1", optional: true },
      { name: "Ichneumon", order: "Hymenoptera", family: "Ichneumonidae", wiki: "Ichneumonidae", bugguide: "1" },
      { name: "Gall Wasp", order: "Hymenoptera", family: "Cynipidae", wiki: "Cynipidae", bugguide: "1", optional: true },
      { name: "Velvet Ant", order: "Hymenoptera", family: "Mutillidae", wiki: "Mutillidae", bugguide: "1" },
      { name: "Ant", order: "Hymenoptera", family: "Formicidae", wiki: "Formicidae", bugguide: "1" },
      { name: "Paper Wasp", order: "Hymenoptera", family: "Vespidae", wiki: "Vespidae", bugguide: "1" },
      { name: "Thread-waisted Wasp", order: "Hymenoptera", family: "Sphecidae", wiki: "Sphecidae", bugguide: "1" },
      { name: "Braconid Wasp", order: "Hymenoptera", family: "Braconidae", wiki: "Braconidae", bugguide: "1", optional: true },
      { name: "Sweat Bee", order: "Hymenoptera", family: "Halictidae", wiki: "Halictidae", bugguide: "1" },
      { name: "Leaf Cutter Bee", order: "Hymenoptera", family: "Megachilidae", wiki: "Megachilidae", bugguide: "1" },
      { name: "Honey Bee", order: "Hymenoptera", family: "Apidae", wiki: "Apidae", bugguide: "1" },
    */
    // END OLD DATA - Now loaded from insects-data.json

    // Group insects by order (will be populated after data loads)
    let orderGroups = {};

    function groupInsectsByOrder() {
      orderGroups = {};
      insectData.forEach(insect => {
        if (!orderGroups[insect.order]) {
          orderGroups[insect.order] = [];
        }
        orderGroups[insect.order].push(insect);
      });
    }

    function showOrders() {
      document.getElementById('order-list').style.display = 'block';
      document.getElementById('family-grid').classList.remove('active');
      document.getElementById('back-btn').classList.remove('active');
      document.getElementById('order-title').classList.remove('active');
      document.getElementById('order-info-box').classList.remove('active');
      
      const orderList = document.getElementById('order-list');
      orderList.innerHTML = '';
      
      // Create sections for each metamorphosis type
      ['ametabolous', 'hemimetabolous', 'holometabolous'].forEach(type => {
        const section = document.createElement('div');
        section.className = 'metamorphosis-section';
        
        const typeInfo = metamorphosisTypes[type];
        section.innerHTML = `
          <h2>${typeInfo.title}</h2>
          <div class="description">${typeInfo.description}</div>
          <div class="order-grid" id="${type}-grid"></div>
        `;
        orderList.appendChild(section);
        
        const grid = section.querySelector('.order-grid');
        
        // Add order cards for this metamorphosis type
        typeInfo.orders.forEach(order => {
          if (orderGroups[order]) {
            const count = orderGroups[order].length;
            const card = document.createElement('div');
            
            // Check if all families in this order are optional
            const allOptional = orderGroups[order].every(insect => insect.optional);
            card.className = 'order-card' + (allOptional ? ' optional' : '');
            
            // Get common name for the order if available
            const commonName = orderInfo[order]?.commonName || '';
            const commonNameDisplay = commonName ? `<div style="margin-top: 8px; font-size: 0.9em; opacity: 0.85; font-style: italic;">${commonName}</div>` : '';
            
            card.innerHTML = `
              <h3>${order}${allOptional ? ' ‚≠ê' : ''}</h3>
              <div class="count">${count} ${count === 1 ? 'family' : 'families'}</div>
              ${commonNameDisplay}
            `;
            card.onclick = () => showFamilies(order);
            grid.appendChild(card);
          }
        });
      });
    }

    function showFamilies(order) {
      document.getElementById('order-list').style.display = 'none';
      document.getElementById('family-grid').classList.add('active');
      document.getElementById('back-btn').classList.add('active');
      document.getElementById('order-title').classList.add('active');
      document.getElementById('order-info-box').classList.add('active');
      
      // Build order title with links
      const orderLink = bugguideLinks.orders?.[order];
      const bugguideButton = orderLink 
        ? `<a href="${orderLink}" target="_blank">BugGuide</a>`
        : '';
      
      document.getElementById('order-title').innerHTML = `
        <span>${order}</span>
        <div class="order-links">
          <a href="https://en.wikipedia.org/wiki/${order}" target="_blank">Wikipedia</a>
          <a href="https://genent.cals.ncsu.edu/insect-identification/order-${order.toLowerCase()}/" target="_blank">NC State</a>
          ${bugguideButton}
          <button onclick="exportOrderPDF('${order}')">üìÑ Export PDF</button>
        </div>
      `;
      
      // Display order information if available
      const infoBox = document.getElementById('order-info-box');
      const info = orderInfo[order];
      
      // Determine metamorphosis type
      let metamorphosisType = '';
      for (const [type, data] of Object.entries(metamorphosisTypes)) {
        if (data.orders.includes(order)) {
          if (type === 'ametabolous') {
            metamorphosisType = 'Ametabolous (No Metamorphosis)';
          } else if (type === 'hemimetabolous') {
            metamorphosisType = 'Hemimetabolous (Incomplete Metamorphosis)';
          } else if (type === 'holometabolous') {
            metamorphosisType = 'Holometabolous (Complete Metamorphosis)';
          }
          break;
        }
      }
      
      if (info) {
        infoBox.innerHTML = `
          <h3>Order Characteristics</h3>
          <div class="info-row">
            <span class="info-label">Metamorphosis:</span>
            <span class="info-value">${metamorphosisType}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Meaning:</span>
            <span class="info-value">'${info.meaning}'</span>
          </div>
          <div class="info-row">
            <span class="info-label">Characteristics:</span>
            <span class="info-value">${info.characteristics}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Wings:</span>
            <span class="info-value">${info.wings}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Children:</span>
            <span class="info-value">${info.children}</span>
          </div>
        `;
      } else {
        infoBox.innerHTML = '';
        infoBox.classList.remove('active');
      }
      
      // Add order notes section
      const orderNote = NotesManager.getOrderNote(order);
      const notesSection = document.createElement('div');
      notesSection.className = 'notes-section';
      notesSection.innerHTML = `
        <h4>üìù My Notes for ${order}</h4>
        <textarea id="order-note-input" placeholder="Add your study notes here...">${orderNote}</textarea>
        <button onclick="saveOrderNote('${order}')">Save Note</button>
      `;
      infoBox.appendChild(notesSection);
      
      const familyGrid = document.getElementById('family-grid');
      familyGrid.innerHTML = '';
      
      orderGroups[order].forEach(async insect => {
        const card = document.createElement('div');
        card.className = 'family-card' + (insect.optional ? ' optional' : '');
        
        const imagePath = `images/${insect.order}/${insect.family}/specimen.jpg`;
        
        // Check if BugGuide link exists for this specific family only (no fallback to order)
        const familyLink = bugguideLinks.families?.[insect.family];
        
        const bugguideButton = familyLink 
          ? `<a href="${familyLink}" target="_blank">BugGuide</a>`
          : '';
        
        // Use shared NC State link function
        const ncStateLink = getNcStateUrl(insect);
        
        const ncStateButton = ncStateLink 
          ? `<a href="${ncStateLink}" target="_blank">NC State</a>`
          : '';
        
        const familyNote = NotesManager.getFamilyNote(insect.family);
        const notePreview = familyNote ? `<div class="notes-display">${familyNote.substring(0, 500)}${familyNote.length > 500 ? '...' : ''}</div>` : '';
        
        card.innerHTML = `
          <h4>${insect.family}</h4>
          <div class="common-name">${insect.name}</div>
          <div class="marks">${insect.marks}</div>
          <div class="image-container" id="img-${insect.family}">
            <div class="placeholder">Loading image...</div>
          </div>
          <div class="links">
            <a href="https://en.wikipedia.org/wiki/${insect.wiki}" target="_blank">Wikipedia</a>
            ${ncStateButton}
            ${bugguideButton}
          </div>
          ${notePreview}
          <button class="add-note-btn" onclick="editFamilyNote('${insect.family}', '${insect.name}')">
            ${familyNote ? '‚úèÔ∏è Edit Note' : 'üìù Add Note'}
          </button>
        `;
        
        familyGrid.appendChild(card);
        
        // Try to load local image first, then fallback to Wikipedia
        loadImage(insect, imagePath);
      });
    }
    
    async function loadImage(insect, localPath) {
      const container = document.getElementById(`img-${insect.family}`);
      const basePath = `images/${insect.order}/${insect.family}/`;
      
      // Try to load multiple images (specimen.jpg, specimen1.jpg, specimen2.jpg, etc.)
      const imageUrls = [];
      
      // Try specimen.jpg first
      const mainImg = await tryLoadImage(`${basePath}specimen.jpg`);
      if (mainImg) imageUrls.push(mainImg);
      
      // Try numbered specimens (specimen1.jpg through specimen10.jpg)
      for (let i = 1; i <= 10; i++) {
        const numberedImg = await tryLoadImage(`${basePath}specimen${i}.jpg`);
        if (numberedImg) {
          imageUrls.push(numberedImg);
        } else if (i > 1) {
          break; // Stop if we hit a missing number
        }
      }
      
      // Always try to add Wikipedia image at the end
      const wikiImg = await fetchInsectImage(insect);
      if (wikiImg) imageUrls.push(wikiImg);
      
      // Display images with carousel if any found
      if (imageUrls.length > 0) {
        displayImageCarousel(container, imageUrls, insect.name);
      } else {
        container.innerHTML = `<div class="placeholder">No image available<br><small>Add to: ${localPath}</small></div>`;
      }
    }
    
    async function tryLoadImage(path) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(path);
        img.onerror = () => resolve(null);
        img.src = path;
      });
    }
    
    function displayImageCarousel(container, imageUrls, altText) {
      let currentIndex = 0;
      
      // Store images in container's dataset
      container.imageUrls = imageUrls;
      container.insectName = altText;
      
      function updateImage() {
        const showNav = imageUrls.length > 1;
        const navButtons = showNav ? `
          <button class="image-nav prev" onclick="event.stopPropagation(); this.parentElement.previousImage()">‚Äπ</button>
          <button class="image-nav next" onclick="event.stopPropagation(); this.parentElement.nextImage()">‚Ä∫</button>
          <div class="image-counter">${currentIndex + 1} / ${imageUrls.length}</div>
        ` : '';
        
        container.innerHTML = `
          <img src="${imageUrls[currentIndex]}" alt="${altText}" style="cursor: pointer;">
          ${navButtons}
        `;
        
        // Add click handler to image
        const img = container.querySelector('img');
        img.onclick = () => {
          openImageModal(container.imageUrls, currentIndex, container.insectName);
        };
      }
      
      container.previousImage = () => {
        currentIndex = (currentIndex - 1 + imageUrls.length) % imageUrls.length;
        updateImage();
      };
      
      container.nextImage = () => {
        currentIndex = (currentIndex + 1) % imageUrls.length;
        updateImage();
      };
      
      updateImage();
    }

    // Save order note
    function saveOrderNote(order) {
      const noteInput = document.getElementById('order-note-input');
      NotesManager.setOrderNote(order, noteInput.value);
      alert('Note saved! Your notes are stored locally in your browser.');
    }
    
    // Edit family note
    let currentEditFamily = null;
    let currentEditFamilyName = null;
    
    function editFamilyNote(family, commonName) {
      currentEditFamily = family;
      currentEditFamilyName = commonName;
      
      const currentNote = NotesManager.getFamilyNote(family);
      document.getElementById('modal-title').textContent = `Notes for ${family} (${commonName})`;
      document.getElementById('modal-textarea').value = currentNote;
      document.getElementById('note-modal').classList.add('active');
    }
    
    function closeNoteModal() {
      document.getElementById('note-modal').classList.remove('active');
      currentEditFamily = null;
      currentEditFamilyName = null;
    }
    
    // Image modal functions
    let modalImages = [];
    let modalCurrentIndex = 0;
    let modalInsectName = '';
    
    function openImageModal(imageUrls, currentIndex, insectName) {
      modalImages = imageUrls;
      modalCurrentIndex = currentIndex;
      modalInsectName = insectName;
      updateModalImage();
      document.getElementById('image-modal').classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    function closeImageModal() {
      document.getElementById('image-modal').classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
    }
    
    function prevModalImage() {
      modalCurrentIndex = (modalCurrentIndex - 1 + modalImages.length) % modalImages.length;
      updateModalImage();
    }
    
    function nextModalImage() {
      modalCurrentIndex = (modalCurrentIndex + 1) % modalImages.length;
      updateModalImage();
    }
    
    function updateModalImage() {
      document.getElementById('image-modal-img').src = modalImages[modalCurrentIndex];
      document.getElementById('image-modal-title').textContent = modalInsectName;
      document.getElementById('image-modal-counter').textContent = `${modalCurrentIndex + 1} / ${modalImages.length}`;
      
      // Hide nav buttons if only one image
      const navButtons = document.querySelectorAll('.image-modal-nav');
      const counter = document.getElementById('image-modal-counter');
      if (modalImages.length <= 1) {
        navButtons.forEach(btn => btn.style.display = 'none');
        counter.style.display = 'none';
      } else {
        navButtons.forEach(btn => btn.style.display = 'flex');
        counter.style.display = 'block';
      }
    }
    
    function saveNoteFromModal() {
      if (!currentEditFamily) return;
      
      const noteText = document.getElementById('modal-textarea').value;
      NotesManager.setFamilyNote(currentEditFamily, noteText);
      
      const familyToRefresh = currentEditFamily;
      closeNoteModal();
      
      // Small delay to ensure modal closes, then refresh
      setTimeout(() => {
        // Find which order this family belongs to and refresh
        for (const [order, insects] of Object.entries(orderGroups)) {
          if (insects.some(i => i.family === familyToRefresh)) {
            showFamilies(order);
            break;
          }
        }
      }, 100);
    }
    
    // Close modal when clicking outside
    document.getElementById('note-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeNoteModal();
      }
    });
    
    // Export all notes to JSON file
    function exportNotes() {
      const notes = {
        exportDate: new Date().toISOString(),
        orderNotes: {},
        familyNotes: {}
      };
      
      // Collect all order notes
      Object.keys(orderGroups).forEach(order => {
        const note = NotesManager.getOrderNote(order);
        if (note) {
          notes.orderNotes[order] = note;
        }
      });
      
      // Collect all family notes
      insectData.forEach(insect => {
        const note = NotesManager.getFamilyNote(insect.family);
        if (note) {
          notes.familyNotes[insect.family] = note;
        }
      });
      
      // Check if there are any notes to export
      if (Object.keys(notes.orderNotes).length === 0 && Object.keys(notes.familyNotes).length === 0) {
        alert('No notes to export. Add some notes first!');
        return;
      }
      
      // Create download
      const dataStr = JSON.stringify(notes, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `entomology-notes-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      alert(`Exported ${Object.keys(notes.orderNotes).length} order notes and ${Object.keys(notes.familyNotes).length} family notes!`);
    }
    
    // Import notes from JSON file (merge with existing)
    function importNotes(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          
          let orderCount = 0;
          let familyCount = 0;
          
          // Merge order notes
          if (importedData.orderNotes) {
            Object.entries(importedData.orderNotes).forEach(([order, note]) => {
              const existingNote = NotesManager.getOrderNote(order);
              if (existingNote && existingNote.trim()) {
                // Merge: append new note to existing with separator
                NotesManager.setOrderNote(order, existingNote + '\n\n--- Imported ---\n' + note);
              } else {
                // No existing note, just set the imported one
                NotesManager.setOrderNote(order, note);
              }
              orderCount++;
            });
          }
          
          // Merge family notes
          if (importedData.familyNotes) {
            Object.entries(importedData.familyNotes).forEach(([family, note]) => {
              const existingNote = NotesManager.getFamilyNote(family);
              if (existingNote && existingNote.trim()) {
                // Merge: append new note to existing with separator
                NotesManager.setFamilyNote(family, existingNote + '\n\n--- Imported ---\n' + note);
              } else {
                // No existing note, just set the imported one
                NotesManager.setFamilyNote(family, note);
              }
              familyCount++;
            });
          }
          
          alert(`Successfully imported and merged ${orderCount} order notes and ${familyCount} family notes!`);
          
          // Reset file input
          event.target.value = '';
          
          // Refresh the current view to show imported notes
          const familyGrid = document.getElementById('family-grid');
          const orderList = document.getElementById('order-list');
          
          if (familyGrid.classList.contains('active')) {
            // We're viewing a specific order, refresh it
            const orderTitle = document.getElementById('order-title').querySelector('span');
            if (orderTitle) {
              const currentOrder = orderTitle.textContent;
              showFamilies(currentOrder);
            }
          } else if (orderList.style.display !== 'none') {
            // We're viewing the order list, refresh it
            showOrders();
          }
          
        } catch (error) {
          alert('Error importing notes: Invalid JSON file format');
          console.error(error);
        }
      };
      
      reader.readAsText(file);
    }
    
    // Export order to PDF with images and notes
    async function exportOrderPDF(order) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 15;
      const contentWidth = pageWidth - (2 * margin);
      
      let yPos = margin;
      
      // Title
      doc.setFontSize(20);
      doc.setTextColor(64, 145, 108);
      doc.text(String(order), margin, yPos);
      yPos += 10;
      
      // Order info
      const info = orderInfo[order];
      if (info) {
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        const commonName = String(info.commonName || 'N/A').replace(/[^\x00-\x7F]/g, '');
        doc.text('Common Name: ' + commonName, margin, yPos);
        yPos += 6;
        
        // Get metamorphosis type
        let metamorphosisType = '';
        for (const [type, data] of Object.entries(metamorphosisTypes)) {
          if (data.orders.includes(order)) {
            if (type === 'ametabolous') metamorphosisType = 'Ametabolous';
            else if (type === 'hemimetabolous') metamorphosisType = 'Hemimetabolous';
            else if (type === 'holometabolous') metamorphosisType = 'Holometabolous';
            break;
          }
        }
        doc.text('Metamorphosis: ' + metamorphosisType, margin, yPos);
        yPos += 10;
      }
      
      // Order notes
      const orderNote = NotesManager.getOrderNote(order);
      if (orderNote) {
        doc.setFontSize(12);
        doc.setTextColor(64, 145, 108);
        doc.text('Order Notes:', margin, yPos);
        yPos += 6;
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);
        const cleanNote = String(orderNote).replace(/[^\x00-\x7F]/g, '');
        const noteLines = doc.splitTextToSize(cleanNote, contentWidth);
        doc.text(noteLines, margin, yPos);
        yPos += (noteLines.length * 5) + 5;
      }
      
      // Add new page for the family grid to avoid overlap
      doc.addPage();
      
      // Get families for this order (exclude optional ones)
      const families = orderGroups[order].filter(insect => !insect.optional);
      
      // Layout in 2x2 grid (4 families per page)
      const cellWidth = (contentWidth - 10) / 2; // 10 for gap between columns
      const cellHeight = 120; // Height per cell including space for notes
      const gapX = 10;
      const gapY = 10;
      
      for (let i = 0; i < families.length; i++) {
        const insect = families[i];
        
        // Calculate position in 2x2 grid
        const row = Math.floor((i % 4) / 2);
        const col = (i % 4) % 2;
        
        // Add new page after every 4 families (but not on the first iteration)
        if (i > 0 && i % 4 === 0) {
          doc.addPage();
        }
        
        const cellX = margin + (col * (cellWidth + gapX));
        const cellY = (i % 4 < 2) ? margin : margin + cellHeight + gapY;
        
        // Draw cell border
        doc.setDrawColor(200, 200, 200);
        doc.rect(cellX, cellY, cellWidth, cellHeight);
        
        let cellYPos = cellY + 8;
        
        // Family name
        doc.setFontSize(11);
        doc.setTextColor(64, 145, 108);
        const familyName = String(insect.family);
        doc.text(familyName, cellX + 5, cellYPos);
        cellYPos += 6;
        
        // Common name (larger font)
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        const commonName = String(insect.name).replace(/[^\x00-\x7F]/g, '');
        const nameLines = doc.splitTextToSize(commonName, cellWidth - 10);
        doc.text(nameLines, cellX + 5, cellYPos);
        cellYPos += (nameLines.length * 5) + 3;
        
        // Try to load and add image
        try {
          const imgElement = document.querySelector('#img-' + insect.family + ' img');
          if (imgElement && imgElement.src) {
            const imgData = await getImageDataURL(imgElement.src);
            if (imgData) {
              // Calculate aspect ratio to prevent cropping
              const maxImgWidth = cellWidth - 10;
              const maxImgHeight = 35;
              
              // Get actual image dimensions
              const img = new Image();
              img.src = imgElement.src;
              await new Promise(resolve => {
                img.onload = resolve;
                img.onerror = resolve;
              });
              
              const aspectRatio = img.width / img.height;
              let imgWidth = maxImgWidth;
              let imgHeight = imgWidth / aspectRatio;
              
              // If height exceeds max, scale by height instead
              if (imgHeight > maxImgHeight) {
                imgHeight = maxImgHeight;
                imgWidth = imgHeight * aspectRatio;
              }
              
              doc.addImage(imgData, 'JPEG', cellX + 5, cellYPos, imgWidth, imgHeight);
              cellYPos += imgHeight + 3;
            }
          }
        } catch (error) {
          console.log('Could not add image for ' + insect.family);
        }
        
        // Family notes (if any)
        const familyNote = NotesManager.getFamilyNote(insect.family);
        if (familyNote) {
          doc.setFontSize(9);
          doc.setTextColor(100, 100, 100);
          const cleanNote = String(familyNote).replace(/[^\x00-\x7F]/g, '');
          const noteLines = doc.splitTextToSize(cleanNote, cellWidth - 10);
          
          // Check if notes will fit in current cell
          const notesHeight = noteLines.length * 4;
          const remainingSpace = cellHeight - (cellYPos - cellY);
          
          if (notesHeight > remainingSpace) {
            // Notes don't fit, continue on next page
            doc.addPage();
            let newYPos = margin;
            
            // Repeat family header on new page
            doc.setFontSize(11);
            doc.setTextColor(64, 145, 108);
            doc.text(familyName + ' (continued)', margin, newYPos);
            newYPos += 8;
            
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(noteLines, margin, newYPos);
          } else {
            // Notes fit in current cell
            doc.text(noteLines, cellX + 5, cellYPos);
          }
        } else {
          // Add "Notes:" label with space for handwritten notes (larger font)
          doc.setFontSize(9);
          doc.setTextColor(150, 150, 150);
          doc.text('Notes: ___________________________', cellX + 5, cellYPos);
          cellYPos += 6;
          doc.text('_____________________________________', cellX + 5, cellYPos);
          cellYPos += 6;
          doc.text('_____________________________________', cellX + 5, cellYPos);
        }
      }
      
      // Save PDF
      doc.save(order + '-study-guide.pdf');
    }
    
    // Helper function to convert image to data URL
    async function getImageDataURL(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = function() {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          try {
            resolve(canvas.toDataURL('image/jpeg', 0.8));
          } catch (e) {
            resolve(null);
          }
        };
        img.onerror = function() {
          resolve(null);
        };
        img.src = url;
      });
    }

    // Load data and initialize
    initBrowse();
  </script>
</body>
</html>
